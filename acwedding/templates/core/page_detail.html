{% extends 'base.html' %}
{% load staticfiles %}
{% load core_tags %}
{% load googlemaps_tags %}

{% block page_title %}{% block h2 %}{{ page.title }}{% endblock h2 %}{% endblock page_title%}

{% block extra_css %}
    {% if has_map %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/gmap.css' %}">
    {% endif %}
    
    {% if has_minigallery %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/magnific-popup.css' %}">
    {% endif %}
{% endblock extra_css %}

{% block content %}
    {% if subheader_image %}
        <div class="subheader-img-wrapper">
            <img class="img-responsive center-block" src="{% static 'images/subheaders/'|add:subheader_image.filename %}" alt="{{ subheader_image.alt_text }}">
            {% if subheader_image.subtitle %}
                <p class="text-center">{{ subheader_image.subtitle|safe}}</p>
            {% endif %}
        </div>
    {% endif %}
    
    {% for section in section_list %}
        <section>
            <h3>{{ section.heading }}</h3>
            
            {{ section.content|removetags:'script'|safe|urlize|reverseurls|rsttotable|bullets|safe|linebreaks }}
            
            {% if section.minigallery %}
                <div class="row popup-gallery">
                    {% for image in section.minigallery.images.all %}
                        <div class="col-md-2 col-sm-2 col-xs-4">
                            <a href="{% static 'images/minigallery/'|add:image.filename %}" class="thumbnail" title="{{ image.caption }}">
                                <img src="{% static 'images/tn/'|add:image.filename|add:'.thumbnail' %}" alt="{{ image.caption }}" title="{{ image.caption }}">
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            {% for audio in section.sectionaudio_set.all %}
                <div>
                     <p><em>{{ audio.description }}</em></p>
                    <audio controls>
                        {% comment %} 
                            !!!!!!!!!!!!!!!!
                            IMPORTANT: It is assumed each audio has .mp3 and .ogg versions with equivalent base filenames.
                            !!!!!!!!!!!!!!!!
                        {% endcomment %}
                        <source src="{% static 'audio/'|add:audio.filename|splitext %}.mp3" type="audio/mpeg">
                        <source src="{% static 'audio/'|add:audio.filename|splitext %}.ogg" type="audio/ogg">
                        <embed height="50" width="100" src="{% static 'audio/'|add:audio.filename|splitext %}.mp3">
                    </audio>
                </div>
            {% endfor %}
            
            {% if section.map %}
                {% simple_map section.map %}
            {% endif %}
        </section>
    {% endfor %}
{% endblock %}


{% block body_end %}   
    {% if has_minigallery %}
        <script src="{% static 'js/magnificpopup.min.js' %}" type="text/javascript"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                $('.popup-gallery').each( function() {
                    $(this).magnificPopup({
                        delegate: 'div a',
                        type: 'image',
                        tLoading: 'Loading image #%curr%...',
                        mainClass: 'mfp-img-mobile',
                        gallery: {
                            enabled: true,
                            navigateByImgClick: true,
                            preload: [0,1] // Will preload 0 - before current, and 1 after the current image
                        },
                        image: {
                            tError: '<a href="%url%">The image #%curr%</a> could not be loaded.',
                            titleSrc: function(item) {
                                return item.el.attr('title');
                            }
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock body_end %}

